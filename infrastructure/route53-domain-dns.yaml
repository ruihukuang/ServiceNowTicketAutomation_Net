# 1-route53-standalone.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Standalone Route 53 Hosted Zone and Certificate for future ALB'

Parameters:
  EnvironmentName:
    Type: String
    Default: "production"
  VpcId:
    Type: AWS::EC2::VPC::Id
  FullDomainName:
    Type: String
    Default: "service-app.square.site" # ğŸ”´ è¯·å°† yourdomain.com æ›¿æ¢æˆæ‚¨æ³¨å†Œçš„çœŸå®åŸŸå
    Description: 'The full API domain name (e.g., api.example.com)'
  VPCRegion: 
    Type: String

Resources:
  # 1. ä½¿ç”¨æ‚¨ç°æœ‰çš„åŸŸååˆ›å»ºæ‰˜ç®¡åŒº
  # æ³¨æ„ï¼šæ­¤æ¨¡æ¿å‡è®¾æ‚¨å·²æ‹¥æœ‰è¯¥åŸŸåã€‚å¦‚éœ€æ³¨å†Œæ–°åŸŸåï¼Œéœ€å…ˆé€šè¿‡ AWS æ§åˆ¶å°æˆ– CLI å®Œæˆã€‚
  HostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref FullDomainName  # âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨ä¼ å…¥çš„åŸŸå
      HostedZoneConfig:
        Comment: !Sub "Hosted zone for ALB endpoints in ${EnvironmentName}"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
      VPCs:
        - VPCId: !Ref  VpcId
          VPCRegion: !Ref  VPCRegion

  # 2. ä¸ºåŸŸåç”³è¯· ACM è¯ä¹¦
  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref FullDomainName
      ValidationMethod: DNS
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  # 3. è¯ä¹¦éªŒè¯è®°å½•
  CertificateValidationRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZone
      Name: !GetAtt SSLCertificate.DomainValidationOptions.0.ResourceRecord.Name
      Type: !GetAtt SSLCertificate.DomainValidationOptions.0.ResourceRecord.Type
      TTL: 300
      ResourceRecords:
        - !GetAtt SSLCertificate.DomainValidationOptions.0.ResourceRecord.Value

  # 4. è¯ä¹¦éªŒè¯èµ„æº
  CertificateValidation:
    Type: AWS::CertificateManager::CertificateValidation
    DependsOn: CertificateValidationRecord
    Properties:
      CertificateArn: !Ref SSLCertificate
      ValidationRecordFqdns:
        - !GetAtt SSLCertificate.DomainValidationOptions.0.ResourceRecord.Name

Outputs:
  HostedZoneId:
    Description: 'Route 53 Hosted Zone ID for ALB'
    Value: !Ref HostedZone
    Export:
      Name: !Sub ${EnvironmentName}-HostedZoneId
  NameServers:
    Description: 'Name Servers for ALB'
    Value: !Join [',', !GetAtt HostedZone.NameServers]
  CertificateArn:
    Description: 'Validated ACM Certificate ARN for ALB Listener'
    Value: !Ref SSLCertificate
    Export:
      Name: !Sub ${EnvironmentName}-CertificateArn
  FullDomainNameOutput:
    Description: 'The domain name to be used for ALB'
    Value: !Ref FullDomainName
    Export:
      Name: !Sub ${EnvironmentName}-FullDomainName