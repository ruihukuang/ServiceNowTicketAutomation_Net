AWSTemplateFormatVersion: '2010-09-09'
Description: 'ECR Repository for caching GHCR images'

Parameters:
  EnvironmentName:
    Type: String
  RepositoryName:
    Type: String

Resources:
  # ECR Repository
  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref RepositoryName
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 30 images",
                "selection": {
                  "tagStatus": "tagged",
                  "tagPrefixList": ["main-", "sha-"],
                  "countType": "imageCountMoreThan",
                  "countNumber": 30
                },
                "action": {
                  "type": "expire"
                }
              },
              {
                "rulePriority": 2,
                "description": "Expire untagged images after 1 day",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "sinceImagePushed",
                  "countUnit": "days",
                  "countNumber": 1
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Source
          Value: ghcr-cache

  # ECR Repository Policy
  ECRRepositoryPolicy:
    Type: AWS::ECR::RepositoryPolicy
    Properties:
      RepositoryName: !Ref ECRRepository
      PolicyText:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AllowECSPull'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action:
              - ecr:BatchCheckLayerAvailability
              - ecr:BatchGetImage
              - ecr:GetDownloadUrlForLayer
            Condition:
              ArnLike:
                aws:SourceArn: !Sub arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/*
          - Sid: 'AllowGitHubActionsPush'
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action:
              - ecr:CompleteLayerUpload
              - ecr:UploadLayerPart
              - ecr:InitiateLayerUpload
              - ecr:BatchCheckLayerAvailability
              - ecr:PutImage
              - ecr:GetAuthorizationToken

Outputs:
  RepositoryName:
    Description: 'ECR Repository Name'
    Value: !Ref ECRRepository
  
  RepositoryUri:
    Description: 'ECR Repository URI'
    Value: !Sub public.ecr.aws/g1n7j8p0/${ECRRepository}
  
  RepositoryArn:
    Description: 'ECR Repository ARN'
    Value: !GetAtt ECRRepository.Arn