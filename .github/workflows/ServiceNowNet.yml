name: Build and Test Docker

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Convert repository name to lowercase
      id: lowercase
      run: |
        # Â∞Ü‰ªìÂ∫ìÂêçÁß∞ËΩ¨Êç¢‰∏∫ÂÖ®Â∞èÂÜô
        REPO_NAME_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "REPO_NAME_LOWER=$REPO_NAME_LOWER" >> $GITHUB_OUTPUT
        echo "Original: ${{ github.repository }}"
        echo "Lowercase: $REPO_NAME_LOWER"

    - name: Build Docker image
      run: |
        docker build -t myapp:${{ github.sha }} .

    - name: Test Docker container
      run: |
        # Start container
        docker run -d -p 8080:8080 --name test-app myapp:${{ github.sha }}
        
        # Wait for startup
        echo "Waiting for application to start..."
        sleep 15
        
        # Test health endpoint
        echo "Testing health endpoint..."
        if curl -f http://localhost:8080/health; then
          echo "‚úÖ Health check passed"
        else
          echo "‚ùå Health check failed"
          echo "Container logs:"
          docker logs test-app
          exit 1
        fi
        
        # Test additional endpoints
        echo "Testing root endpoint..."
        curl -s http://localhost:8080/ || echo "Root endpoint test failed"
        
        # Check logs for errors
        echo "Checking container logs..."
        docker logs test-app
        
        # Stop and remove container
        docker stop test-app
        docker rm test-app

    - name: Push to GHCR (only on main)
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      run: |
        # ÁôªÂΩïÂà∞ GitHub Container Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑÂ∞èÂÜôÂêçÁß∞
        echo "Tagging images..."
        docker tag myapp:${{ github.sha }} ghcr.io/${{ steps.lowercase.outputs.REPO_NAME_LOWER }}:${{ github.sha }}
        docker tag myapp:${{ github.sha }} ghcr.io/${{ steps.lowercase.outputs.REPO_NAME_LOWER }}:latest
        
        echo "Pushing images to GHCR..."
        docker push ghcr.io/${{ steps.lowercase.outputs.REPO_NAME_LOWER }}:${{ github.sha }}
        docker push ghcr.io/${{ steps.lowercase.outputs.REPO_NAME_LOWER }}:latest
        
        echo "‚úÖ Images pushed successfully!"
        echo "üì¶ Repository: ghcr.io/${{ steps.lowercase.outputs.REPO_NAME_LOWER }}"
        echo "üè∑Ô∏è  Tags: ${{ github.sha }} and latest"
