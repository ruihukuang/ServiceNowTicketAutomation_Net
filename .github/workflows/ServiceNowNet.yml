name: Build and Test Docker

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t myapp:${{ github.sha }} .

    - name: Test Docker container
      run: |
        # Start container
        docker run -d -p 8080:8080 --name test-app myapp:${{ github.sha }}
        
        # Wait for startup
        sleep 15
        
        # Test it
        curl -f http://localhost:8080/health || exit 1
        
        # Check logs for errors
        docker logs test-app
        
        # Stop container
        docker stop test-app
        docker rm test-app

    - name: Push to GHCR (only on main)
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      run: |
        docker tag myapp:${{ github.sha }} ghcr.io/${{ github.repository }}:${{ github.sha }}
        docker tag myapp:${{ github.sha }} ghcr.io/${{ github.repository }}:latest
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker push ghcr.io/${{ github.repository }} --all-tags